<html>
 <head>
  <title>Word Cloud Test</title>
  <style type="text/css">
	div#wordcloud {
		position: relative;
	}
	div#wordcloud div.wordclouditem {
		display: inline-block;
		padding: 0.1em;
	}
  </style>
 </head>
 <body>
  <p>Current time: <span id="now"></span>, next event: <span id="next"></span></p>
  <div id="wordcloud"></div>
  <script src="jquery.js"></script>
  <script type="text/javascript">
	function WordCloud(dom_parent, dom_template, surface) {
		this.total = 0;
		this.dictionary = {};
		this.stopwords = [];
		this.dom_parent = dom_parent;
		this.dom_template = dom_template;
		this.surface = surface;
		this.ewma = 1;
		this.ewma_timer = null;
	}
	WordCloud.prototype.countOccurence = function (words) {
		if( typeof(words) == 'string' ) words = [ words ];
		for(var i in words) {
			var word = words[i];
			if( $.inArray(word.toLowerCase(), this.stopwords) > -1 ) continue;

			var old = this.dictionary[word.toLowerCase()];
			if( old == undefined ) {
				old = {count: 0, caps: {}};
			}
			if( old.caps[word] == undefined ) old.caps[word] = 0;

			this.total++;
			old.count++;
			old.caps[word]++;

			this.dictionary[word.toLowerCase()] = old;
		}
		if( this.ewma_timer == null ) this.tick();
	};
	WordCloud.prototype.tick = function () {
		var that = this;
		var reduce = function (input) { return input * that.ewma; };
		$.each(this.dictionary, function (index, value) {
			$.each(value.caps, function(index, value) {
				value = reduce(value);
			});
			value.count = reduce(value.count);
		});
		this.total = reduce(this.total);
		this.cleanup();
	};
	WordCloud.prototype.cleanup = function () {
		var that = this;
		$.each(this.dictionary, function (index, value) {
			if( value.count < 0.1 ) {
				that.total -= value.count;
				delete that.dictionary[value];
			}
		});
	}
	WordCloud.prototype.setEwma = function (halftime, type) {
		var delta = 0.95
		if( this.ewma_timer != null ) {
			clearTimeout(this.ewma_timer);
			this.ewma_timer = null;
		}
		if( type == 'seconds' ) {
			var ticktime = halftime*1000 / (Math.log(.5)/Math.log(delta));
			this.ewma = delta;

			var that = this; var closure = function () { var that2 = that; that2.tick(); that2.updateCloud(); };
			this.ewma_timer = setInterval(closure, ticktime);
		} else if( type == 'messages' ) {
			this.ewma = Math.pow(.5, 1/halftime);
		}
	};
	WordCloud.prototype.addStopWords = function (words) {
		if( typeof(words) == 'string' ) words = [ words ];
		// Add them to the stopword list
		this.stopwords = this.stopwords.concat(words);
		// And remove the new stopwords from the dictionary
		var that = this;
		$.each(words, function (index, value) {
			if( that.dictionary[value] != undefined ) {
				that.total -= that.dictionary[value].count;
				delete that.dictionary[value];
			}
		});
	};
	WordCloud.prototype.wipe = function () {
		this.total = 0;
		this.total = 0;
		this.dictionary = {};
	};
	WordCloud.prototype.getOccurences = function (word) {
		item = this.dictionary[word.toLowerCase()];
		if( item == undefined ) return [0, '', null]
		highscore = 0;
		for(var i in item.caps) {
			if( item.caps[i] > highscore ) {
				word = i;
				highscore = item.caps[i];
			}
		}
		return [item.count, word, item];
	};
	WordCloud.prototype.getWords = function () {
		keys = [];
		for(var i in this.dictionary) { keys.push(i); }
		return keys;
	}
	WordCloud.prototype.updateCloud = function() {
		var surface = 0;
		var that = this;
		var sorted_words = this.getWords().sort( function(a, b) {
				return that.dictionary[b].count - that.dictionary[a].count;
		});
		$.each(sorted_words, function(index, word) {
			var data = wordfreq.getOccurences(word);
			var count = data[0]; var word = data[1];
			/*
			 * Calculate the expected count of each word (if every word is equally likely)
			 * Calculate the ratio of the actual count vs the expected count
			 * Non-linear power-function function to compress this output
			 */
			var size = Math.pow(count,0.7);
			surface += word.length*size;

			if( surface < that.surface ) {
				if( data[2].dom == undefined ) {
					// Create a DOM element
					data[2].dom = that.dom_template.clone()
					data[2].dom.text(word).css('font-size', '0%');
					that.dom_parent.append(data[2].dom);
				}
				// DOM exists, animate
				data[2].dom.animate({'font-size': (size*100+'%')}, 400);
			} else {
				if( data[2].dom != undefined ) {
					var dom_to_remove = data[2].dom;
					data[2].dom.animate({'font-size': '0pt'}, 400, function() {
						dom_to_remove.remove();
					});
					data[2].dom = undefined;
				}
			}
		});
	};
  </script>
  <script src="http://46.137.24.146/socket.io/socket.io.js"></script>
  <script src="jquery.json.js"></script>
  <script type="text/javascript">
   var ffwd = 10;
   var now = 0;
   var events;
   function time_passes() {
		now++;
		// Assume events are sorted
		while( events[0].offset < now ) {
			e = events.shift();
			add_words(e.text);
			wordfreq.updateCloud();
		}
		$("#now").text(now);
		$("#next").text(events[0].offset);
   }
   $.getJSON('fake_input.json', function(data) {
		events = data;
		setInterval("time_passes();", 1000/ffwd);
   });

   wordfreq = new WordCloud( $("#wordcloud"), $("<div class='wordclouditem'/>"), 500 );
   wordfreq.setEwma(300/ffwd, 'seconds');
   $.ajax({
		url: "stopwords.txt",
		success: function(text) {
			wordfreq.addStopWords( text.split(/\s+/) );
		}
	});

   function add_words(text) {
		words = text.match(/http:\/\/[a-zA-Z0-9./?=&-]+|[#@]?[a-zA-Z][a-zA-Z'-]+/g);

		{ // only count unique words, duplicate words in the same comment are ignored
			h = {};
			for(var i in words) { h[words[i]] = 1; }
			words = [];
			for(var i in h) { words.push(i); }
		}

		wordfreq.countOccurence(words);
   }
  </script>
 </body>
</html>
