<html>
 <head>
  <title>Word Cloud Test</title>
  <style type="text/css">
   ul.wordcloud {
		list-style-type: none;
		padding: 0;
		margin: 0;
   }
   ul.wordcloud li {
		display: inline-block;
		padding: 0.2em;
   }
  </style>
 </head>
 <body>
  <ul id="wordcloud" class="wordcloud">
  </ul>
  <ul id="activities">
  </ul>
  <script src="javascripts/jquery-1.5.1.min.js"></script>
  <script type="text/javascript">
	function WordCloud(dom_parent, dom_template, surface) {
		this.unique_count = 0;
		this.total = 0;
		this.dictionary = {};
		this.stopwords = [];
		this.dom_parent = dom_parent;
		this.dom_template = dom_template;
		this.surface = surface;
		this.ewma = 1;
		this.ewma_timer = null;
	}
	WordCloud.prototype.countOccurence = function (words) {
		if( typeof(words) == 'string' ) words = [ words ];
		for(var i in words) {
			var word = words[i];
			if( $.inArray(word.toLowerCase(), this.stopwords) > -1 ) continue;

			var old = this.dictionary[word.toLowerCase()];
			if( old == undefined ) {
				this.unique_count++;
				old = {count: 0, caps: {}};
			}
			if( old.caps[word] == undefined ) old.caps[word] = 0;

			this.total++;
			old.count++;
			old.caps[word]++;

			this.dictionary[word.toLowerCase()] = old;
		}
		if( this.ewma_timer == null ) this.tick();
	};
	WordCloud.prototype.tick = function () {
		var that = this;
		var reduce = function (input) { return input * that.ewma; };
		$.each(this.dictionary, function (index, value) {
			$.each(value.caps, function(index, value) {
				value = reduce(value);
			});
			value.count = reduce(value.count);
		});
		this.total = reduce(this.total);
	};
	WordCloud.prototype.setEwma = function (halftime, type) {
		var delta = 0.95
		if( this.ewma_timer != null ) {
			clearTimeout(this.ewma_timer);
			this.ewma_timer = null;
		}
		if( type = 'seconds' ) {
			var ticktime = halftime*1000 / (Math.log(.5)/Math.log(delta));
			this.ewma = delta;
			this.ewma_timer = setInterval(this.tick /* Without ()!! */, ticktime);
		} else if( type = 'messages' ) {
			this.ewma = Math.pow(.5, 1/halftime);
		}
	};
	WordCloud.prototype.wipe = function () {
		this.unique_count = 0;
		this.total = 0;
		this.total = 0;
		this.dictionary = {};
	};
	WordCloud.prototype.getOccurences = function (word) {
		item = this.dictionary[word.toLowerCase()];
		if( item == undefined ) return [0, '', null]
		highscore = 0;
		for(var i in item.caps) {
			if( item.caps[i] > highscore ) {
				word = i;
				highscore = item.caps[i];
			}
		}
		return [item.count, word, item];
	};
	WordCloud.prototype.getWords = function () {
		keys = [];
		for(var i in this.dictionary) { keys.push(i); }
		return keys;
	}
	WordCloud.prototype.updateCloud = function() {
		var surface = 0;
		var that = this;
		var sorted_words = this.getWords().sort( function(a, b) {
				return that.dictionary[b].count - that.dictionary[a].count;
		});
		$.each(sorted_words, function(index, word) {
			var data = wordfreq.getOccurences(word);
			var count = data[0]; var word = data[1];
			/*
			 * Calculate the expected count of each word (if every word is equally likely)
			 * Calculate the ratio of the actual count vs the expected count
			 * Non-linear power-function function to compress this output
			 */
			var size = Math.pow(count * that.unique_count / that.total,0.7);
			surface += word.length*size;

			if( surface < that.surface ) {
				if( data[2].dom == undefined ) {
					// Create a DOM element
					data[2].dom = that.dom_template.clone()
					data[2].dom.text(word).css('font-size', (size*100+'%'));
					that.dom_parent.append(data[2].dom);
				} else {
					// DOM exists, animate
					data[2].dom.animate({'font-size': (size*100+'%')}, 400);
				}
			} else {
				if( data[2].dom != undefined ) {
					data[2].dom.animate({'font-size': '0pt'}, 400, function() {
						data[2].dom.remove();
						data[2].dom = undefined;
					});
				}
			}
		});
	};
  </script>
  <script src="http://46.137.24.146/socket.io/socket.io.js"></script>
  <script src="javascripts/jquery.json-2.2.min.js"></script>
  <script type="text/javascript">
   supported_actions = ['twitter','facebook','comment'];

   $.getJSON('http://beheer.villavanthilt.be/activities.json?callback=?', function(data) {
		a = $.parseJSON( data.activities );
		for(var i in a) {
			if( $.inArray( a[i].action, supported_actions) > -1 ) {
				add_words(a[i].message);
			}
		}
		wordfreq.updateCloud();
   });

   var socket = new io.Socket('46.137.24.146');
   socket.connect();
   socket.on('connect', function(){
		socket.send( $.toJSON({ action: 'join', program: 'all' }) );
   });
   socket.on('disconnect', function(){
		alert('disconected');
		setTimeout("socket.connect();", 1000);
   });
   socket.on('message', function(e){ 
		a = $.parseJSON( e.data );
		if( $.inArray( a.activity.action, supported_actions) > -1 ) {
			add_words( a.activity.message );
			wordfreq.updateCloud();
		}
   });

   wordfreq = new WordCloud( $("#wordcloud"), $("<li/>"), 500 );
   wordfreq.setEwma(60, 'seconds');
   wordfreq.stopwords = wordfreq.stopwords.concat( "de het een".split(' ') );
   wordfreq.stopwords = wordfreq.stopwords.concat( "en of".split(' ') );
   wordfreq.stopwords = wordfreq.stopwords.concat( "ik jij je gij ge hij zij wij we jullie".split(' ') );
   wordfreq.stopwords = wordfreq.stopwords.concat( "dit dat deze da".split(' ') );
   wordfreq.stopwords = wordfreq.stopwords.concat( "nog wel niet ja nee neen".split(' ') );
   wordfreq.stopwords = wordfreq.stopwords.concat( "hoe waar wanneer waarom".split(' ') );
   wordfreq.stopwords = wordfreq.stopwords.concat( "om over op zo van met voor in".split(' ') );
   wordfreq.stopwords = wordfreq.stopwords.concat( "ben bent is zijn was waren".split(' ') );
   wordfreq.stopwords = wordfreq.stopwords.concat( "heb hebt hebben".split(' ') );

   function add_words(text) {
		words = text.match(/http:\/\/[a-zA-Z0-9./?=&-]+|@?[a-zA-Z][a-zA-Z-]+/g);

		{ // only count unique words, duplicate words in the same comment are ignored
			h = {};
			for(var i in words) { h[words[i]] = 1; }
			words = [];
			for(var i in h) { words.push(i); }
		}

		wordfreq.countOccurence(words);
   }
  </script>
 </body>
</html>
