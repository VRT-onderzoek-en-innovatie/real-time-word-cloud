<html>
 <head>
  <title>Word Cloud Test</title>
  <style type="text/css">
   ul.wordcloud {
		list-style-type: none;
		padding: 0;
		margin: 0;
   }
   ul.wordcloud li {
		display: inline-block;
		padding: 0.2em;
   }
  </style>
 </head>
 <body>
  <ul id="wordcloud" class="wordcloud">
  </ul>
  <ul id="activities">
  </ul>
  <script src="javascripts/jquery-1.5.1.min.js"></script>
  <script type="text/javascript">
   function WordCloud() {
		this.count = 0;
		this.dictionary = {};
		this.stopwords = [];
		this.countOccurence = function (words) {
			if( typeof(words) == 'string' ) words = [ words ];
			for(var i in words) {
				var word = words[i];
				if( $.inArray(word, this.stopwords) > -1 ) return;

				var old = this.dictionary[word.toLowerCase()];
				if( old == undefined ) old = {count: 0, caps: {}};
				if( old.caps[word] == undefined ) old.caps[word] = 0;

				this.count++;
				old.count++;
				old.caps[word]++;

				this.dictionary[word.toLowerCase()] = old;
			}
		};
		this.wipe = function () {
			this.count = 0;
			this.dictionary = {};
		};
		this.getOccurences = function (word) {
			item = this.dictionary[word.toLowerCase()];
			if( item == undefined ) return [0, ''];
			highscore = 0;
			for(var i in item.caps) {
				if( item.caps[i] > highscore ) {
					word = i;
					highscore = item.caps[i];
				}
			}
			return [item.count, word];
		};
		this.getWords = function () {
			keys = [];
			for(var i in this.dictionary) { keys.push(i); }
			return keys;
		}
   }
  </script>
  <script src="http://46.137.24.146/socket.io/socket.io.js"></script>
  <script src="javascripts/jquery.json-2.2.min.js"></script>
  <script type="text/javascript">
   supported_actions = ['twitter','facebook','comment'];

/*
   $.getJSON('http://beheer.villavanthilt.be/activities.json?callback=?', function(data) {
		a = $.parseJSON( data.activities );
		for(var i in a) {
			if( $.inArray( a[i].action, supported_actions) > -1 ) {
				add_words(a[i].message);
			}
		}
   });

   var socket = new io.Socket('46.137.24.146');
   socket.connect();
   socket.on('connect', function(){
		socket.send( $.toJSON({ action: 'join', program: 'all' }) );
   });
   socket.on('disconnect', function(){
		alert('disconected');
		setTimeout("socket.connect();", 1000);
   });
   socket.on('message', function(e){ 
		a = $.parseJSON( e.data );
		if( $.inArray( a.activity.action, supported_actions) > -1 ) {
			add_words( a.activity.message );
		}
   });
*/
   $.getJSON('http://beheer.villavanthilt.be/activities.json?callback=?', function(data) {
		delay = 1;
		a = $.parseJSON( data.activities );
		for(var i in a) {
			if( $.inArray( a[i].action, supported_actions) > -1 ) {
				setTimeout("add_words("+$.toJSON(a[i].message)+");", delay*1000);
				delay++;
			}
		}
   });

   function add_words(text) {
		words = text.match(/@?[a-zA-Z][a-zA-Z-]+/g);

		{ // only count unique words, duplicate words in the same comment are ignored
			h = {};
			for(var i in words) { h[words[i]] = 1; }
			words = [];
			for(var i in h) { words.push(i); }
		}

		update_wordcloud(words);
   }

   wordfreq = new WordCloud();
   wordfreq.stopwords = "de het een en ik jij hij zij wij jullie om over op zo van met".split(' ');
   current_threshold = 0;
   function update_wordcloud(words) {
		for(var i in words) {
			wordfreq.countOccurence(words[i]);
		}

		$("#wordcloud").empty();
		words = wordfreq.getWords();
		for(var i in words) {
			data = wordfreq.getOccurences(words[i]);
			count = data[0]; word = data[1];
			if( count > current_threshold ) {
				size = 50000*count/wordfreq.count+'%';
				item = $('<li/>').text(word).css('font-size', size);
				$("#wordcloud").append(item);
			}
		}
   }
  </script>
 </body>
</html>
